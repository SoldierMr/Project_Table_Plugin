<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./css/qd_table.min.css">
    <script src="./js/qd_table.min.js"></script>
    <script src='./js/contextMenu.min.js'></script>
    <style>
        .mainDiv{
            width: 100%;
            height: 100%;
            overflow: auto;

            display: flex;
            display: -webkit-flex;

            flex-direction: row;
            -webkit-flex-direction: row;
        }
        .leftListDiv{
            width: 250px;
            height: 100%;
        }
        .tableDiv {
            width: 3000px;
            height: 100%;
            flex:1;
            -webkit-flex:1;
            overflow: auto;
        }
        .classListDiv {
            width: 230px;
            height: auto;
           /* border: 1px solid #000000;
            border-top: transparent;*/
            overflow-x: hidden;
            overflow-y: auto;
            position: fixed;
            margin: auto;
            top: 10px;
            left: 10px;
            bottom: 10px;
        }
        .classList {
            width: 100%;
            height: auto;
            background-color: #eeeeee;
            border-bottom: 1px solid #000000;
            /*用户不能选取*/
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .listItem {
            width: 100%;
            height: 40px;
            background-color: transparent;
            border-top: 1px solid #000000;
            cursor: pointer;

            display: flex;
            display: -webkit-flex;

            flex-direction: row;
            -webkit-flex-direction: row;

            justify-content: space-between;
            -webkit-justify-content: space-between;

            align-items: center;
            -webkit-align-items: center;
        }
        .listItemName{
            font-size: 14px;
            color: #000000;
            margin-left: 15px;
        }
        .upTriangle{
            width: 0;
            height: 0;
            margin-right: 15px;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid #000000;
        }
        .downTriangle{
            width: 0;
            height: 0;
            margin-right: 15px;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 10px solid #000000;
        }
        .secondListDiv{
            width: 100%;
            height: auto;
        }
        .secondList {
            width: 100%;
            height: auto;
            background-color: #dddddd;
            position: relative;
            top: 0;
            left: 0;
        }
        .secondListShadow {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            pointer-events: none;

            -webkit-box-shadow: 0 0 15px 5px #aaaaaa inset;
            -moz-box-shadow: 0 0 15px 5px #aaaaaa inset;
            box-shadow: 0 0 15px 5px #aaaaaa inset;
        }
        .heightPanelDivBg{
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10;
        }
        .heightPanelDiv{
            width: 350px;
            height: 275px;
            /*height: 525px;*/
            background-color: #ffffff;
            padding: 10px;
            overflow: hidden;
            position: absolute;
            margin: auto;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;

            /*禁止选中文本*/
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .heightPanelTitle{
            width: 100%;
            height: 30px;
            margin-left: 5px;
            font-size: 18px;
            line-height: 30px;
        }
        .heightPanelContentDiv {
            width: 100%;
            height: auto;
            border: 1px solid #c3c3c3;
            border-top: transparent;
        }
        .heightItemDiv{
            width: 100%;
            height: auto;
        }
        .heightItemHeadDiv {
            width: 100%;
            height: 40px;
            border-top: 1px solid #c3c3c3;
            cursor: pointer;

            display: flex;
            display: -webkit-flex;

            flex-direction: row;
            -webkit-flex-direction: row;

            justify-content: flex-start;
            -webkit-justify-content: flex-start;

            align-items: center;
            -webkit-align-items: center;
        }
        .heightItemHeadCheckBox{
            width: 15px;
            height: 15px;
            margin-left: 20px;
        }
        .heightItemName{
            width: auto;
            height: auto;
            font-size: 16px;
            margin-left: 10px;
        }
        .heightItemContentDiv{
            width: 100%;
            height: auto;
            position: relative;
        }
        .heightItemContentValueDiv{
            width: 100%;
            height: 40px;
            background-color: #eeeeee;
            border-top: 1px solid #c3c3c3;

            display: flex;
            display: -webkit-flex;

            flex-direction: row;
            -webkit-flex-direction: row;

            justify-content: flex-start;
            -webkit-justify-content: flex-start;

            align-items: center;
            -webkit-align-items: center;
        }
        .shadowDiv {
            width: 100%;
            height: 100%;
            box-shadow: 0 0 10px 3px #aaaaaa inset;
            position: absolute;
            top: 0;
            left: 0;
            /*穿透*/
            pointer-events: none;
        }
        .heightValueName {
            width: 80px;
            height: 100%;
            font-size: 16px;
            text-align: right;
            line-height: 40px;
        }
        .heightValueInput {
            width: 200px;
            height: 30px;
            text-indent: 5px;
            border: 1px solid #999999;
        }
        .heightPanelBtnDiv{
            width: 100%;
            height: 30px;
            margin-top: 10px;

            display: flex;
            display: -webkit-flex;

            flex-direction: row;
            -webkit-flex-direction: row;

            justify-content: space-around;
            -webkit-justify-content: space-around;
        }
        .heightPanelBtn {
            width: 70px;
            height: 100%;
            border: transparent;
            border-radius: 2px;
            color: #ffffff;
            outline: none;
            cursor: pointer;
        }
        .heightPanelBtn:active{
            box-shadow:0 5px 30px 5px #9d9d9d inset;
        }
        .trueButton{
            background-color: #00aaff;
        }
        .falseButton{
            background-color: #ff0000;
        }

        ._displayNone{
            display: none;
        }
        ._selectBgColor{
            background-color: #00aaff;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <object id="qdutils" type="application/plugin-QdUtils.dll" style="width:0;height:0; position:absolute; top:-100px;"></object>
    <div class="mainDiv">
        <div class="leftListDiv">
            <div id="classList" class="classListDiv"></div>
        </div>
        <div class="tableDiv">
            <table id="table1"></table>
        </div>
    </div>
    <div id="heightPanel" class="heightPanelDivBg _displayNone">
        <div class="heightPanelDiv">
            <p class="heightPanelTitle">设置高度</p>
            <div class="heightPanelContentDiv">
                <div class="heightItemDiv">
                    <div class="heightItemHeadDiv">
                        <input class="heightItemHeadCheckBox" type="checkbox" value="1" onchange="heightPanelCheckBoxEvent(this)">
                        <p class="heightItemName">固定值</p>
                    </div>
                    <div class="heightItemContentDiv _displayNone">
                        <div class="heightItemContentValueDiv">
                            <p class="heightValueName">数值：</p>
                            <input class="heightValueInput"  type="text" placeholder="请输入纯数字值（请用 | 隔开）" oninput="intInput(this)">
                        </div>
                        <div class="shadowDiv"></div>
                    </div>
                </div>
                <div class="heightItemDiv">
                    <div class="heightItemHeadDiv">
                        <input class="heightItemHeadCheckBox" type="checkbox" value="2" onchange="heightPanelCheckBoxEvent(this)">
                        <p class="heightItemName">范围值</p>
                    </div>
                    <div class="heightItemContentDiv _displayNone">
                        <div class="heightItemContentValueDiv">
                            <p class="heightValueName">最小值：</p>
                            <input class="heightValueInput" type="text" placeholder="请输入最小值（纯数字）" oninput="minIntInput(this)" onblur="minIntInputBlur(this)">
                        </div>
                        <div class="heightItemContentValueDiv">
                            <p class="heightValueName">最大值：</p>
                            <input class="heightValueInput" type="text" placeholder="请输入最大值（纯数字）" oninput="maxIntInput(this)" onblur="maxIntInputBlur(this)">
                        </div>
                        <div class="shadowDiv"></div>
                    </div>
                </div>
                <div class="heightItemDiv">
                    <div class="heightItemHeadDiv">
                        <input class="heightItemHeadCheckBox" type="checkbox" value="3" onchange="heightPanelCheckBoxEvent(this)">
                        <p class="heightItemName">递增值</p>
                    </div>
                    <div class="heightItemContentDiv _displayNone">
                        <div class="heightItemContentValueDiv">
                            <p class="heightValueName">最小值：</p>
                            <input class="heightValueInput" type="text" placeholder="请输入最小值（纯数字）" oninput="minIntInput(this)" onblur="minIntInputBlur(this)">
                        </div>
                        <div class="heightItemContentValueDiv">
                            <p class="heightValueName">最大值：</p>
                            <input class="heightValueInput" type="text" placeholder="请输入最大值（纯数字）" oninput="maxIntInput(this)" onblur="maxIntInputBlur(this)">
                        </div>
                        <div class="heightItemContentValueDiv">
                            <p class="heightValueName">递增值：</p>
                            <input class="heightValueInput" type="text" placeholder="请输入递增值（纯数字）" oninput="incrementValueInput(this)" onblur="incrementValueBlur(this)">
                        </div>
                        <div class="shadowDiv"></div>
                    </div>
                </div>
                <div class="heightItemDiv">
                    <div class="heightItemHeadDiv">
                        <input class="heightItemHeadCheckBox" type="checkbox" value="4" onchange="heightPanelCheckBoxEvent(this)">
                        <p class="heightItemName">分数值</p>
                    </div>
                    <div class="heightItemContentDiv _displayNone">
                        <div class="heightItemContentValueDiv">
                            <p class="heightValueName">数值：</p>
                            <input class="heightValueInput" type="text" placeholder="请输入分数值（请用 | 隔开）" oninput="fractionInput(this)">
                        </div>
                        <div class="shadowDiv"></div>
                    </div>
                </div>
                <div class="heightItemDiv">
                    <div class="heightItemHeadDiv">
                        <input class="heightItemHeadCheckBox" type="checkbox" value="5" onchange="heightPanelCheckBoxEvent(this)">
                        <p class="heightItemName">自定义</p>
                    </div>
                </div>
            </div>
            <div class="heightPanelBtnDiv">
                <button class="heightPanelBtn trueButton" onclick="extractHeightData(this)">确定</button>
                <button class="heightPanelBtn falseButton" onclick="heightPanelHidden()">取消</button>
            </div>
        </div>
    </div>
</body>

<script>
	var path = qdutils.GetQuickDrawPath () + 'QdCloud\\Sliding\\趟门配置表\\';
	var name_path = path + '门板类型.cfg';
    var bomDataPath = path + '门板附加物料.cfg';
	var borderTypeLinkDataPath = path + '趟门参数.cfg';
    var wjDataPath = path + '五金配件分类.cfg';
	var data = qdutils.ReadStringFromFile(name_path);
	var borderTypeLinkDataSource = JSON.parse(qdutils.ReadStringFromFile(borderTypeLinkDataPath));
    var wjDataSource = JSON.parse(qdutils.ReadStringFromFile(wjDataPath));
    var bomDataSource = JSON.parse(qdutils.ReadStringFromFile(bomDataPath));
	var borderTypeLinkData = [];
    var wjTypeDataSource = [];
    var bomTypeDataSource = [];
    var dataSource;
    var booleanArr = ['TRUE','FALSE'];
    var LinesArr = ['横纹','竖纹','斜纹'];
    var treeData;
    //筛选全部的标志
    var filter_all = '*';
    //筛选后生成的新数据源
    var resetDataSource = [];
    //筛选出来的数据项下标数组
    var resetItemIndexArr = [];
    //是否是原数据源引用
    var isOldDataSource = true;
    //存储提取的数据子项
    var dataItem;
    //存储当前修改高度面板的序号
    var nowResetHeightPanelTrNumber;

	if(data==''){
		data='[]';
	}
    dataSource = JSON.parse(data);
    borderTypeLinkDataSource.forEach(function (linkData) {
       if(isInArray(linkData.name,borderTypeLinkData) < 0) {
           borderTypeLinkData.push(linkData.name);
       }
    });
    bomDataSource.forEach(function(linkData) {
        if(isInArray(linkData.bomclass,bomTypeDataSource) < 0) {
            bomTypeDataSource.push(linkData.bomclass);
        }
    })
    wjDataSource.forEach(function(linkData) {
        if(isInArray(linkData.name,wjTypeDataSource) < 0) {
            wjTypeDataSource.push(linkData.name);
        }
    })
    dataSource.forEach(function (data) {
        if(data.name === undefined) data.name = '';
        if(data.jtValue === undefined) data.jtValue = '';
        if(data.wjname === undefined) data.wjname = '';
        if(data.bktype === undefined) data.bktype = '';
        if(data.groupname === undefined) data.groupname = '';
        if(data.Eheight === undefined) data.Eheight = '';
        if(data.lmax === undefined) data.lmax = '';
        if(data.lmin === undefined) data.lmin = '';
        if(data.wmax === undefined) data.wmax = '';
        if(data.wmin === undefined) data.wmin = '';
        if(data.direct === undefined) data.direct = '';
        if(data.panel2d === undefined) data.panel2d = '';
        if(data.slaVe === undefined) data.slaVe = '';
        if(data.slaVe2 === undefined) data.slaVe2 = '';
        if(data.mk3d === undefined) data.mk3d = '';
        if(data.mkl === undefined) data.mkl = '';
        if(data.mkH === undefined) data.mkH = '';
        if(data.tHick === undefined) data.tHick = '';
        if(data.ypos === undefined) data.ypos = '';
        if(data.memo === undefined) data.memo = '';
        if(data.memo2 === undefined) data.memo2 = '';
        if(data.memo3 === undefined) data.memo3 = '';
        if(data.bdfile === undefined) data.bdfile = '';
        data.isglass = (data.isglass === undefined) ? 'FALSE' : data.isglass;
        data.isbaiye = (data.isbaiye === undefined) ? 'FALSE' : data.isbaiye;
        data.iswHole = (data.iswHole === undefined) ? 'FALSE' : data.iswHole;
        if(data['isglass']!= undefined && data.hasOwnProperty('isglass')) {
            if(data['isglass'] == 0) {
                data['isglass'] = 'FALSE';
            }else if(data['isglass']!=0 && data['isglass']!='FALSE'){
                data['isglass'] = 'TRUE';
            }
        }
        if(data['isbaiye']!= undefined && data.hasOwnProperty('isbaiye')) {
            if(data['isbaiye'] == 0) {
                data['isbaiye'] = 'FALSE';
            }else if(data['isbaiye']!=0 && data['isbaiye']!='FALSE'){
                data['isbaiye'] = 'TRUE';
            }
        }
        if(data['iswHole']!= undefined && data.hasOwnProperty('iswHole')) {
            if(data['iswHole'] == 0) {
                data['iswHole'] = 'FALSE';
            }else if(data['iswHole']!=0 && data['iswHole']!='FALSE'){
                data['iswHole'] = 'TRUE';
            }
        }
        
    });
    if(dataSource.length < 1) {
        var objt = {
            name : '',
            jtValue : '',
            wjname : '',
            bktype : '',
            groupname : '',
            Eheight : '',
            lmax : '',
            lmin : '',
            wmax : '',
            wmin : '',
            direct : '',
            panel2d : '',
            slaVe : '',
            slaVe2 : '',
            mk3d : '',
            mkl : '',
            mkH : '',
            tHick : '',
            ypos : '',
            memo : '',
            memo2 : '',
            memo3 : '',
            bdfile : '',
            isglass : '',
            isbaiye : '',
            iswHole : ''
        };
        dataSource.push(objt);
    }
    var testData = {
        rewriteTableTitle:{
            dataSource:{
                name:'材料类型',
                jtValue:'胶条位',
                wjname:'关联五金',
                isglass:'是否玻璃',
                isbaiye:'是否木板',
                iswHole:'整板不分格',
                bktype:'边框类型',
                groupname:'组别',
                lmax:'最大长度',
                wmax:'最大宽度',
                lmin:'最小长度',
                wmin:'最小宽度',
                direct:'纹路',
                panel2d:'2D/3D链接',
                slaVe:'附加物料',
                mk3d:'套框3D',
                mkl:'套框宽度减量',
                mkH:'套框高度减量',
                tHick:'厚度',
                memo:'备注',
                memo2:'备注2',
                memo3:'备注3',
                bdfile:'BD文件',
                Eheight:'设置高度'
            }
        },
        showColumn:{
            attrNameArr:['name','jtValue','wjname','isglass','isbaiye','iswHole','bktype','groupname','lmax','wmax','lmin','wmin','direct','panel2d','slaVe','mk3d','mkl','mkH','tHick','memo','memo2','memo3','bdfile','Eheight']
        },
        setColumnOrder:{
            columnOrder:['name','jtValue','wjname','isglass','isbaiye','iswHole','bktype','groupname','lmax','wmax','lmin','wmin','direct','panel2d','slaVe','mk3d','mkl','mkH','tHick','memo','memo2','memo3','bdfile','Eheight']
        },
        writeLinkData:[
            {
                attrName:'iswHole',
                dataSource:booleanArr,
                isMoreSelect:false
            },{
                attrName:'isglass',
                dataSource:booleanArr,
                isMoreSelect:false
            },{
                attrName:'isbaiye',
                dataSource:booleanArr,
                isMoreSelect:false
            },{
                attrName:'wjname',
                dataSource:wjTypeDataSource,
                isMoreSelect:false
            },{
                attrName:'direct',
                dataSource:LinesArr,
                isMoreSelect:false
            },{
                attrName:'slaVe',
                dataSource:bomTypeDataSource,
                isMoreSelect:false
            },{
                attrName:'bktype',
                dataSource:borderTypeLinkData,
                isMoreSelect:false
            }
        ],
        setTableWidth:{
            tableWidth:3000,
            isEqual:true
        },
        setEditColumn:{
            editNameArr:['name','jtValue','wjname','isglass','isbaiye','iswHole','bktype','groupname','lmax','wmax','lmin','wmin','direct','panel2d','slaVe','mk3d','mkl','mkH','tHick','memo','memo2','memo3','Eheight']
        },
        setPartRows:{
            partRows:10,
            isPaging:true
        },
        setTableLineHeight:{
            lineHeight:'30px'
        },
        tableLabelRender:[{
                attrName:'Eheight',
                htmlStr:'<button class="_qd_funBtnSize" style="width:70px;height:30px;margin:5px;background-color: #000fff;color: #ffffff;" name="setHeight" onclick="heightPanelShow(this)">设置高度</button>'
        }],
        buttonRender:{
          isCleanAll:false,
          htmlStr:['<button style="background-color: #47a447;color: #ffffff;" class="_qd_funBtnSize" name="save" onclick="dataSave()">保存</button>','<button style="background-color: #ed9c28;color: #ffffff;" class="_qd_funBtnSize" name="save" onclick="javascript:location.reload();">取消</button>']
        }
    };
    var test = new qd_Table();
    treeData = initSortData(dataSource,['bktype','groupname']);
    //生成列表
    initClassTree(treeData,['bktype','groupname']);
    //绑定列表点击事件
    classListMouseDown();
    //生成table
    test.setData('table1',dataSource,testData);
    //设置添加的回调函数
    // //高度面板点击事件
    heightPanelMouseDown();
    test.setAddBtnCallBack(function (data) {
        if(!isOldDataSource) {
            data.forEach(function(key,index) {
                dataSource.push(key);
                resetItemIndexArr.push(dataSource.length - 1);
            })
        }
    });
    //设置删除的回调函数
    test.setDelBtnCallBack(function (delIndexArr) {
        if(!isOldDataSource) {
            var delIndex;
            delIndexArr.reverse();
            while (delIndexArr.length > 0){
                delIndex = parseInt(delIndexArr.shift());
                dataSource.splice(resetItemIndexArr[delIndex],1);
                resetItemIndexArr.splice(delIndex,1);
                //每当删除了除最后一个子项外的子项，在其之后的所有子项都必须 - 1，否则会导致合并数据错误
                resetItemIndexArr.forEach(function (item,index) {
                    if(index > (delIndex - 1)){
                        resetItemIndexArr[index] = item - 1;
                    }
                });
            }
        }
    });

    window.onbeforeunload = function () {
        test = null;
        dataSource = null;
        qdutils = null;
    };

    function dataSave() {
        var newDataSource = [];
        dataSource.forEach(function(data){
            if(data.name!=''){
                if(data.lmax =='') data.lmax = '0';
                if(data.lmin =='') data.lmin = '0';
                if(data.wmax =='') data.wmax = '0';
                if(data.wmin =='') data.wmin = '0';
                if(data.mkl =='') data.mkl = '0';
                if(data.mkH =='') data.mkH = '0';
                if(data.tHick =='') data.tHick = '0';

                if(data['isglass'] == 0) {
                    data['isglass'] = 'FALSE';
                }else if(data['isglass']!=0 && data['isglass']!='FALSE'){
                    data['isglass'] = 'TRUE';
                }

                if(data['isbaiye'] == 0) {
                    data['isbaiye'] = 'FALSE';
                }else if(data['isbaiye']!=0 && data['isbaiye']!='FALSE'){
                    data['isbaiye'] = 'TRUE';
                }

                if(data['iswHole'] == 0) {
                    data['iswHole'] = 'FALSE';
                }else if(data['iswHole']!=0 && data['iswHole']!='FALSE'){
                    data['iswHole'] = 'TRUE';
                }
                newDataSource.push(data);
            }
        })
        dataStr = JSON.stringify(newDataSource);
        qdutils.WriteStringToFile(name_path,dataStr);
        alert('保存成功');
    }
    var opt1 = {
        tableId: 'table1',//table的id
        selectClass: '_qd_tableContentDiv',
        bgClass: '_global_trSelectBgColor',
        menuId: 'menu',//menu的id
        oldDataSource: dataSource
    };
    var rightclick = new RightClickText();
    rightclick._initial(opt1);
    document.onmousedown = function(ev){
        if(ev.button == 0) {
            menu.style.display = 'none';
            var event = ev || window.event;
            var target = event.target || event.srcElement;
            if((target.cellIndex == 24) && target.parentNode.parentNode.parentNode.parentNode.className.indexOf('_qd_tableContentDiv') > -1) {
                onfileSave(target);
            }
        }
    }
    /**
     * 新增函数
     * 用于判断数组是否存在某数据
     */
    function isInArray(itemData,arr) {
        if(!(arr instanceof Array)){
            console.log('isInArray的arr参数需为Array');
            return;
        }
        var returnIndex = -1;
        var index;
        for(index in arr){
            if(itemData == arr[index]){
                returnIndex = index;
                break;
            }
        }
        return returnIndex;
    }
    /**
     * 新增函数
     * 分类数据提取初始化
     */
    function initSortData(dataSource,levelArr) {
        if(levelArr.length == 0){
            console.log('函数initSortData的levelArr是空数组');
            return;
        }
        var returnTreeData;
        var attrName;
        var treeItem;
        if(levelArr.length < 2){
            returnTreeData = [];
            returnTreeData.push(filter_all);
            dataSource.forEach(function (data) {
                treeItem = data[levelArr[0]];
                if(isInArray(treeItem,returnTreeData) == -1){
                    returnTreeData.push(treeItem);
                }
            });
        }else {
            returnTreeData = {};
            returnTreeData[filter_all] = [''];
            dataSource.forEach(function (data) {
                attrName = data[levelArr[0]];
                treeItem = data[levelArr[1]];
                if(returnTreeData[attrName] === undefined){
                    returnTreeData[attrName] = [];
                }
                if (isInArray(treeItem,returnTreeData[attrName]) == -1){
                    returnTreeData[attrName].push(treeItem);
                }
            });
        }
        return returnTreeData;
    }
    /**
     * 新增函数
     * 生成分类列表
     */
    function initClassTree(dataTree,levelArr) {
        if(typeof dataTree != 'object'){
            console.log('initClassTree函数的dataTree需为object/array');
            return;
        }
        var classListObj = document.getElementById('classList');
        var classListHTML = '<ul class="classList"></ul>';
        var listItemHTML = '<li class="listItem"><p class="listItemName"></p><div class="upTriangle _displayNone"></div></li>';
        var secondListDivHTML = '<div class="secondListDiv _displayNone"><ul class="secondList"></ul></div>';
        var secondListShadowHTML = '<li class="secondListShadow"></li>';
        var newInnerHTML;
        var secondListInnerHTML;
        var listItemInnerHTML;
        //最外层</ul>的
        var lastUlRule = /<\/ul>$/;
        if(dataTree instanceof Array){
            newInnerHTML = classListHTML;
            dataTree.forEach(function (treeItem) {
                newInnerHTML = newInnerHTML.replace('</ul>',listItemHTML + '</ul>').replace('<p class="listItemName"></p>','<p class="listItemName">' + treeItem + '</p>')
                    .replace('<li class="listItem">','<li class="listItem" name="' + levelArr[0] + '">');
            })
        }else {
            newInnerHTML = classListHTML;
            Object.keys(dataTree).forEach(function (treeAttr) {
                if(dataTree[treeAttr].length == 1 && dataTree[treeAttr][0] == ''){
                    //先修改列表的子项
                    listItemInnerHTML = listItemHTML.replace('<p class="listItemName"></p>','<p class="listItemName">' + treeAttr + '</p>')
                        .replace('<li class="listItem">','<li class="listItem" name="' + levelArr[0] + '">');
                    //写入列表子项
                    newInnerHTML = newInnerHTML.replace(lastUlRule,listItemInnerHTML + '</ul>');
                }else {
                    listItemInnerHTML = listItemHTML.replace('<p class="listItemName"></p>','<p class="listItemName">' + treeAttr + '</p>')
                        .replace('<li class="listItem">','<li class="listItem" name="' + levelArr[0] + '">')
                        .replace('<div class="upTriangle _displayNone"></div>','<div class="upTriangle"></div>');
                    newInnerHTML = newInnerHTML.replace(lastUlRule,listItemInnerHTML + '</ul>');
                    secondListInnerHTML = secondListDivHTML;
                    dataTree[treeAttr].forEach(function (childItem) {
                        secondListInnerHTML = secondListInnerHTML.replace('</ul>',listItemHTML + '</ul>')
                            .replace('<li class="listItem">','<li class="listItem" name="' + levelArr[1] + '">')
                            .replace('<p class="listItemName"></p>','<p class="listItemName">' + childItem + '</p>');
                    });
                    secondListInnerHTML = secondListInnerHTML.replace('</ul>',secondListShadowHTML + '</ul>');
                    newInnerHTML = newInnerHTML.replace(lastUlRule,secondListInnerHTML + '</ul>');
                }
            })
        }
        classListObj.innerHTML = newInnerHTML;
    }
    /**
     * 新增函数
     * 绑定分类列表点击事件
     */
    function classListMouseDown() {
        var classListObj = document.getElementById('classList');
//        var tableId = classListObj.parentNode.nextElementSibling.firstElementChild.getAttribute('id');
        classListObj.addEventListener('mousedown',function(event){
           classListEvent(event)
        });
    }
    /**
     * 新增函数
     * 分类列表点击事件
     */
    function classListEvent(event) {
        var nowActObj = event.target;
        var nowLiObj;
        var nowUlObj;
        var nowTriangleObj;
        var secondListObj;
        var filterConfig;
        var firstItemObj;
        var firstItemName;
        var secondItemName;
        if(nowActObj && (nowActObj.tagName.toLowerCase() == 'li' || nowActObj.parentNode.tagName.toLowerCase() == 'li')){
            nowLiObj = (nowActObj.tagName.toLowerCase() == 'li') ? nowActObj : nowActObj.parentNode;
            nowUlObj = nowLiObj.parentNode;
            nowTriangleObj = nowLiObj.lastElementChild;
            if(nowLiObj.className.indexOf('_selectBgColor') < 0){
                if(nowLiObj.parentNode.className.indexOf('secondList') < 0){
                    //如果当前点击对象不是二级列表，就把二级列表都隐藏
                    initSecondListShow();
                }
                //初始化被分类列表的选中状态
                initSelect();
                //合并数据源
                if(!isOldDataSource){
                    mergeData(dataSource,resetDataSource,resetItemIndexArr);
                }else{
                    resetDataSource = [];
                }
                console.log(resetDataSource);
                nowLiObj.classList.add('_selectBgColor');
                filterConfig = {};
                if(nowUlObj.className.indexOf('secondList') > -1){
                    firstItemObj = nowUlObj.parentNode.previousElementSibling;
                    secondItemName = nowLiObj.getAttribute('name');
                    firstItemName = firstItemObj.getAttribute('name');
                    filterConfig[firstItemName] = firstItemObj.firstElementChild.textContent;
                    filterConfig[secondItemName] = nowLiObj.firstElementChild.textContent;
                }else {
                    firstItemName = nowLiObj.getAttribute('name');
                    filterConfig[firstItemName] = nowLiObj.firstElementChild.textContent;
                }
                //提取数据和下标集合
                extractNewDataSource(dataSource,resetDataSource,resetItemIndexArr,filterConfig);
                // console.log(isOldDataSource)
                if(isOldDataSource) {
                    resetDataSource = dataSource;
                }
                //重写数据并显示表格
                test.resetData('table1',resetDataSource,testData);
                var opt2 = {
                    tableId: 'table1',//table的id
                    selectClass: '_qd_tableContentDiv',
                    bgClass: '_global_trSelectBgColor',
                    menuId: 'menu',//menu的id
                    oldDataSource: resetDataSource
                };
                rightclick._initial(opt2);
            }
            if(nowTriangleObj.className.indexOf('_displayNone') < 0){
                secondListObj = nowLiObj.nextElementSibling;
                if(secondListObj.className.indexOf('_displayNone') > -1){
                    secondListObj.classList.remove('_displayNone');
                    nowTriangleObj.classList.remove('upTriangle');
                    nowTriangleObj.classList.add('downTriangle');
                }else {
                    secondListObj.classList.add('_displayNone');
                    nowTriangleObj.classList.remove('downTriangle');
                    nowTriangleObj.classList.add('upTriangle');
                }
            }
        }
    }
    /**
     * 新增函数
     * 初始化被分类列表的选中状态
     */
    function initSelect() {
        var classListObj = document.getElementById('classList');
        var liArr = classListObj.getElementsByTagName('li');
        var liIndex;
        for (liIndex in liArr){
            if(!isNaN(liIndex)){
                if(liArr[liIndex].className.indexOf('_selectBgColor') > -1){
                    liArr[liIndex].classList.remove('_selectBgColor');
                    break;
                }
            }
        }
        classListObj = null;
        liArr = null;
    }

    /**
     * 新增函数
     * 初始化列表的展开状态
     */
    function initSecondListShow() {
        var classListObj = document.getElementById('classList');
        var secondListArr = classListObj.getElementsByClassName('secondListDiv');
        var listKey;
        var triangleDivObj;

        for (listKey in secondListArr){
            if(!isNaN(listKey) && secondListArr[listKey].className.indexOf('_displayNone') < 0){
                secondListArr[listKey].classList.add('_displayNone');
                triangleDivObj = secondListArr[listKey].previousElementSibling.lastElementChild;
                triangleDivObj.classList.remove('downTriangle');
                triangleDivObj.classList.add('upTriangle');
            }
        }
    }

    /**
     * 新增函数
     * 合并数据
     */
    function mergeData(oldData,newData,filterIndexArr) {
        var key;
        var index;
        while (filterIndexArr.length > 0){
            key = filterIndexArr.shift();
            oldData[key] = newData.shift();
        }
        for (index in arguments){
            if(!isNaN(index)){
                arguments[index] = null;
            }
        }
    }
    
    /**
     * 新增函数
     * 提取新的数据源和被提取子项的下标集合
     */ 
    function extractNewDataSource(oldData,newData,filterIndexArr,filterConfig) {
        var attrNameArr = Object.keys(filterConfig);
        var attrKey;
        var isOk;
        for(attrKey in attrNameArr){
            if(!isNaN(attrKey)){
                if(filterConfig[attrNameArr[attrKey]] == filter_all){
                    isOldDataSource = true;
                    break
                }else {
                    isOldDataSource = false;
                }
            }
        }
        oldData.forEach(function (item,index) {
            isOk = true;
            for(attrKey in attrNameArr){
                if(!isNaN(attrKey)){
                    if(filterConfig[attrNameArr[attrKey]] == filter_all){
                        isOk = false;
                        break
                    }else if(item[attrNameArr[attrKey]] != filterConfig[attrNameArr[attrKey]]){
                        isOk = false;
                        break;
                    }
                }
            }
            if(isOk){
                newData.push(item);
                filterIndexArr.push(index);
            }

        })
    }
    /**
     * 新增函数
     * 绑定高度面板的点击事件
     */
    function heightPanelMouseDown() {
        var heightPanel = document.getElementById('heightPanel');
        var contentObj = heightPanel.getElementsByClassName('heightPanelContentDiv')[0];

        contentObj.addEventListener('mousedown', function (event) {
            runCheckBoxEvent(event);
        });
    }
    /**
     * 新增函数
     * 触发高度面板每项的点击事件
     */
    function runCheckBoxEvent (event) {
        var nowActObj = event.target;
        var heightPanelItemCheckBoxObj;
        if((nowActObj.tagName.toLowerCase() == 'p' && nowActObj.className.indexOf('heightItemName') > -1)
            || (nowActObj.tagName.toLowerCase() === 'div' && nowActObj.className.indexOf('heightItemHeadDiv') > -1)){
            if (nowActObj.tagName.toLowerCase() == 'p'){
                heightPanelItemCheckBoxObj = nowActObj.previousElementSibling;
            }else {
                heightPanelItemCheckBoxObj = nowActObj.firstElementChild;
            }
            heightPanelItemCheckBoxObj.checked = !heightPanelItemCheckBoxObj.checked;
            heightPanelItemCheckBoxObj.onchange();
        }
    }
    /**
     * 新增函数
     * 复选框的change事件
     */
    function heightPanelCheckBoxEvent(_this) {
        var checkBoxObj = _this;
        var isSelect = checkBoxObj.checked;
        var heightItemHeadObj = _this.parentNode;
        var heightItemContentObj = heightItemHeadObj.nextElementSibling;
        var heightPanelDivObj = document.getElementById('heightPanel').firstElementChild;
        var trueHeight = heightPanelDivObj.clientHeight;
        if(heightItemContentObj != null){
            if(isSelect){
                heightItemContentObj.classList.remove('_displayNone');
                heightPanelDivObj.style.height = (trueHeight - 20) + heightItemContentObj.offsetHeight + 'px';
            }else {
                heightPanelDivObj.style.height = (trueHeight - 20) - heightItemContentObj.offsetHeight + 'px';
                heightItemContentObj.classList.add('_displayNone');
            }
        }
        checkBoxObj = null;
        heightItemHeadObj = null;
        heightItemContentObj = null;
        heightPanelDivObj = null;
    }
    /**
     * 新增函数
     * 展示高度面板
     */
    function heightPanelShow(_this) {
        var heightPanelBtn = _this;
        var nowTdObj = heightPanelBtn.parentNode;
        var dataItemId = parseInt(nowTdObj.parentNode.getElementsByTagName('td')[1].textContent) - 1;
        var trueData = (resetDataSource === undefined || resetDataSource.length == 0) ? dataSource : resetDataSource;
        nowResetHeightPanelTrNumber = dataItemId;
        dataItem = trueData[dataItemId];
        initHeightPanel(dataItem.Eheight);
    }
    /**
     * 新增函数
     * 高度面板初始化
     */
    function initHeightPanel(heightData) {
        var heightPanelObj = document.getElementById('heightPanel');
        var heightPanelContentObj = heightPanelObj.getElementsByClassName('heightPanelContentDiv')[0];
        var heightPanelItemArr = heightPanelContentObj.getElementsByClassName('heightItemDiv');
        var heightPanelItemInputArr;
        var heightDataItemArr = heightData.split('-');
        var actCheckBoxObj;
        var itemValueArr;
        var actItemIndex;
        var itemIndex;
        var inputIndex;
//       这里不先展示的话就读取不到clientHeight了；
        heightPanelObj.classList.remove('_displayNone');
        for (itemIndex in heightPanelItemArr){
            if(!isNaN(itemIndex)){
                actCheckBoxObj = heightPanelItemArr[itemIndex].firstElementChild.getElementsByTagName('input')[0];
                actCheckBoxObj.checked = false;
                actCheckBoxObj.onchange();
                //此处防止自定义checkbox的value被修改
                if(actCheckBoxObj.parentNode.nextElementSibling != null){
                    heightPanelItemInputArr = heightPanelItemArr[itemIndex].lastElementChild.getElementsByTagName('input');
                    for(inputIndex in heightPanelItemInputArr){
                        if(!isNaN(inputIndex)){
                            heightPanelItemInputArr[inputIndex].value = '';
                        }
                    }
                }
            }
        }
        heightDataItemArr.forEach(function (item) {
            if(item != ''){
                itemValueArr = item.split('|');
                actItemIndex = itemValueArr.shift();
                actCheckBoxObj = heightPanelItemArr[actItemIndex - 1].firstElementChild.getElementsByTagName('input')[0];
                actCheckBoxObj.checked = true;
                actCheckBoxObj.onchange();
                if(actCheckBoxObj.parentNode.nextElementSibling != null){
                    heightPanelItemInputArr = heightPanelItemArr[actItemIndex - 1].lastElementChild.getElementsByTagName('input');
                    if(heightPanelItemInputArr.length > 1){
                        itemValueArr.forEach(function (itemValue,index) {
                            heightPanelItemInputArr[index].value = itemValue;
                        })
                    }else {
                        heightPanelItemInputArr[0].value = itemValueArr.join('|');
                    }
                }
            }
        });
        heightPanelObj = null;
        heightPanelContentObj = null;
        heightPanelItemArr = null;
        heightPanelItemInputArr = null;
        actCheckBoxObj = null;
    }
    /**
     * 新增函数
     * 整数输入
     */
    function intInput(_this) {
        var inputObj = _this;
        var inputValue = inputObj.value;
        var intRule = /[^0-9|]/g;
        inputObj.value = inputValue.replace(intRule,'');
        inputObj = null;
    }
    /**
     * 新增函数
     * 最小值输入
     */
    function minIntInput(_this) {
        var inputObj = _this;
        var inputValue = inputObj.value;
        var minIntRule = /[^0-9]/g;
        inputObj.value = inputValue.replace(minIntRule,'');
        inputObj = null;
    }
    /**
     * 新增函数
     * 最小值的失焦函数
     */
    function minIntInputBlur(_this) {
        var minInputObj = _this;
        var nowItemInputArr = minInputObj.parentNode.parentNode.getElementsByTagName('input');
        var maxInputObj = nowItemInputArr[1];
        var incrementInputObj = nowItemInputArr[2];

        if(!(parseInt(maxInputObj.value) > parseInt(minInputObj.value))){
            maxInputObj.value = parseInt(minInputObj.value) + 1;
        }

        if(incrementInputObj != undefined && incrementInputObj != null){
            if(incrementInputObj.value > (parseInt(maxInputObj.value) - parseInt(minInputObj.value))){
                incrementInputObj.value = parseInt(maxInputObj.value) - parseInt(minInputObj.value);
            }
        }
        minInputObj = null;
        maxInputObj = null;
        incrementInputObj = null;
    }
    /**
     * 新增函数
     * 最大值输入
     */
    function maxIntInput(_this) {
        var inputObj = _this;
        var inputValue = inputObj.value;
        var maxIntRule = /[^0-9]/g;
        var minInputObj = inputObj.parentNode.previousElementSibling.getElementsByTagName('input')[0];
        inputObj.value = inputValue.replace(maxIntRule,'');
        inputObj = null;
        minInputObj = null;
    }
    /**
     * 新增函数
     * 最大值失焦
     */
    function maxIntInputBlur(_this) {
        var maxInputObj = _this;
        var nowItemInputArr = maxInputObj.parentNode.parentNode.getElementsByTagName('input');
        var minInputObj = nowItemInputArr[0];
        var incrementInputObj = nowItemInputArr[2];

        if(!(parseInt(maxInputObj.value) > parseInt(minInputObj.value))){
            maxInputObj.value = parseInt(minInputObj.value) + 1;
        }

        if(incrementInputObj != undefined && incrementInputObj != null){
            if(incrementInputObj.value > (parseInt(maxInputObj.value) - parseInt(minInputObj.value))){
                incrementInputObj.value = parseInt(maxInputObj.value) - parseInt(minInputObj.value);
            }
        }
        minInputObj = null;
        maxInputObj = null;
        incrementInputObj = null;
    }
    /**
     * 新增函数
     * 递增值输入
     */
    function incrementValueInput (_this) {
        var inputObj = _this;
        var inputValue = inputObj.value;
        var inputArr = inputObj.parentNode.parentNode.getElementsByTagName('input');
        var minInputObj = inputArr[0];
        var maxInputObj = inputArr[1];
        var minValue = parseInt(minInputObj.value);
        var maxValue = parseInt(maxInputObj.value);
        if(inputValue > (maxValue - minValue)){
            inputObj.value = maxValue - minValue;
        }
        inputObj = null;
        inputArr = null;
        minInputObj = null;
        maxInputObj = null;
    }

    /**
     * 新增函数
     * 递增值失焦
     */
    function incrementValueBlur(_this) {
        var inputObj = _this;
        var inputValue = inputObj.value;
        if(inputValue == ''){
            inputObj.value = 1;
        }
        inputObj = null;
    }

    /**
     * 新增函数
     * 分数输入
     */
    function fractionInput(_this) {
        var fractionObj = _this;
        var fractionValue = fractionObj.value;
        var errorStrRule = /[^0-9|/]/g;
        var waringStrRule = /(\/|\|)+[^0-9]+/g;
        var slashStrRule = /\/[0-9]+\//g;
        var verticalStrRule = /\|[0-9]+\|/g;

        fractionObj.value = fractionValue.replace(errorStrRule,'').replace(waringStrRule,function (str) {
            return str[0];
        }).replace(slashStrRule,function (str) {
            return str.slice(0,-1);
        }).replace(verticalStrRule,function (str) {
            return str.slice(0,-1);
        });

        fractionObj = null;
    }
    /**
     * 新增函数
     * 高度面板数据合成
     */
    function extractHeightData(_this) {
        var trueBtnObj = _this;
        var heightPanelContentObj = trueBtnObj.parentNode.previousElementSibling;
        var heightItemObjArr = heightPanelContentObj.getElementsByClassName('heightItemDiv');
        var checkBoxObj;
        var dataInputArr;
        var valueArr;
        var itemDataArr = [];
        var itemKey;
        var inputKey;

        for(itemKey in heightItemObjArr){
            if(!isNaN(itemKey)){
                checkBoxObj = heightItemObjArr[itemKey].firstElementChild.getElementsByTagName('input')[0];
                if(checkBoxObj.checked){
                    valueArr = [];
                    valueArr.push(checkBoxObj.value);
                    if(checkBoxObj.parentNode.nextElementSibling != null){
                        dataInputArr = checkBoxObj.parentNode.nextElementSibling.getElementsByTagName('input');
                        for(inputKey in dataInputArr){
                            if(!isNaN(inputKey)){
                                valueArr.push(dataInputArr[inputKey].value);
                            }
                        }
                    }else {
                        valueArr.push('');
                    }
                    itemDataArr.push(valueArr.join('|'));
                }
            }
        }
        //判断筛选下标数组,当为0是用原数据源,不为0是用筛选数据源
        if(resetItemIndexArr.length != 0){
            dataSource[resetItemIndexArr[nowResetHeightPanelTrNumber]].Eheight = itemDataArr.join('-');
        }else {
            dataSource[nowResetHeightPanelTrNumber].Eheight = itemDataArr.join('-');
        }
        heightPanelHidden();
    }
    /**
     * 新增函数
     * 隐藏高度面板
     */
    function heightPanelHidden() {
        var heightPanelObj = document.getElementById('heightPanel');
        heightPanelObj.classList.add('_displayNone');
    }
    function onfileSave(this_) {
        var that = this_;
        var that_parentText = that.textContent;
        var thatAttrName = that.getAttribute('attrname');
        var thatParentIndex = that.parentNode.firstElementChild.nextElementSibling.textContent - 1;
        var filePathName  = qdutils.ShowOpenFileDialog(that_parentText, '*.bd|*.bd');

        that.textContent = filePathName.substring(filePathName.indexOf('\\bd') + 1,filePathName.length);
        if(resetDataSource.length == 0) {
            for(var trIndex in dataSource) {
                if(trIndex == thatParentIndex) {
                    dataSource[trIndex][thatAttrName] = that.textContent;
                }
            }
        }else {
            for(var trIndex in resetDataSource) {
                if(trIndex == thatParentIndex) {
                    resetDataSource[trIndex][thatAttrName] = that.textContent;
                }
            }
        }
        that = null;
    }
</script>
</html>